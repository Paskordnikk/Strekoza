# Настройка Telegram Bot для выгрузки файлов

## Описание

Приложение теперь поддерживает отправку файлов через Telegram Bot API. Когда пользователь открывает приложение через Telegram Web App и нажимает "Выгрузить", файл автоматически отправляется ему через бота @Streko_Zza_bot.

## Настройка

### 1. Получение токена бота

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/mybots`
3. Выберите вашего бота @Streko_Zza_bot
4. Выберите "API Token"
5. Скопируйте токен (выглядит как `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

### 2. Установка токена на сервере

#### Вариант 1: Через переменную окружения (рекомендуется)

**Windows (PowerShell):**
```powershell
$env:TELEGRAM_BOT_TOKEN="ваш_токен_бота"
python server.py
```

**Windows (CMD):**
```cmd
set TELEGRAM_BOT_TOKEN=ваш_токен_бота
python server.py
```

**Linux/Mac:**
```bash
export TELEGRAM_BOT_TOKEN="ваш_токен_бота"
python server.py
```

#### Вариант 2: Через файл .env

1. Создайте файл `.env` в корне проекта:
```
TELEGRAM_BOT_TOKEN=ваш_токен_бота
```

2. Установите `python-dotenv`:
```bash
pip install python-dotenv
```

3. Запустите сервер:
```bash
python server.py
```

#### Вариант 3: Для продакшена (Render.com, Heroku и т.д.)

Добавьте переменную окружения `TELEGRAM_BOT_TOKEN` в настройках вашего хостинга.

## Как это работает

1. Пользователь открывает приложение через Telegram Web App
2. При нажатии на кнопку "Выгрузить" (маршрут или точки):
   - Приложение получает user ID из Telegram Web App
   - Отправляет файл на сервер через API `/api/send_file`
   - Сервер отправляет файл пользователю через Telegram Bot API
   - Пользователь получает файл в чате с ботом

3. В обычном браузере (не Telegram Web App):
   - Файл скачивается стандартным способом через браузер

## Проверка работы

1. Убедитесь, что токен бота установлен:
   - Проверьте логи сервера при запуске
   - Если токен не установлен, вы увидите предупреждение

2. Откройте приложение через Telegram Web App

3. Создайте маршрут или точки и нажмите "Выгрузить"

4. Проверьте чат с ботом @Streko_Zza_bot - файл должен быть там

## Устранение неполадок

### Файл не отправляется

1. **Проверьте консоль браузера (F12)**
   - Откройте DevTools (F12) в Telegram Web App
   - Перейдите на вкладку "Console"
   - Нажмите "Выгрузить" и посмотрите логи
   - Должны быть сообщения:
     - "Обнаружен Telegram Web App, пытаемся получить user ID..."
     - "User ID получен через..." или ошибка получения user ID
     - "Отправка запроса на: ..."
     - Ответ сервера

2. **Проверьте логи сервера на Render.com**
   - Зайдите в панель управления Render.com
   - Откройте логи вашего сервиса
   - При отправке файла должны появиться сообщения:
     - `[INFO] Получен запрос на отправку файла...`
     - `[INFO] Telegram Bot Token установлен...`
     - `[INFO] Отправка файла через Telegram Bot API...`
     - `[INFO] Ответ от Telegram API: status=200` или ошибка

3. **Проверьте токен бота**
   - Убедитесь, что переменная окружения `TELEGRAM_BOT_TOKEN` установлена на Render.com
   - Проверьте, что токен правильный (должен начинаться с цифр и содержать двоеточие)
   - В логах сервера при старте должно быть: `[INFO] Telegram Bot Token установлен (первые 10 символов: ...)`

4. **Проверьте user ID**
   - В консоли браузера должно быть сообщение "User ID получен через..."
   - Если user ID не получен, проверьте, что приложение открыто через Telegram Web App
   - Убедитесь, что пользователь авторизован в Telegram

5. **Проверьте бота**
   - Убедитесь, что пользователь начал диалог с ботом (отправил `/start`)
   - Проверьте, что бот не заблокирован пользователем
   - Убедитесь, что бот активен и работает

### Ошибка "Telegram Bot Token не настроен"

1. Установите переменную окружения `TELEGRAM_BOT_TOKEN` на Render.com
2. Перезапустите сервис
3. Проверьте логи при старте - должно быть сообщение об установке токена

### Ошибка "Не удалось отправить файл через бота"

1. **Проверьте логи сервера** - там будет детальная информация об ошибке
2. **Частые причины:**
   - Пользователь не начал диалог с ботом (`/start`)
   - Бот заблокирован пользователем
   - Неверный токен бота
   - Файл слишком большой (лимит Telegram: 50 МБ)
   - Проблемы с сетью

### Ошибка "Не удалось получить user ID"

1. Убедитесь, что приложение открыто через Telegram Web App (не в обычном браузере)
2. Проверьте консоль браузера - там будет информация о доступных данных Telegram Web App
3. Возможно, нужно обновить версию Telegram Web App SDK

### Проверка работы

1. Откройте приложение через Telegram Web App
2. Откройте консоль браузера (F12)
3. Нажмите "Выгрузить"
4. Проверьте логи в консоли:
   - Должен быть получен user ID
   - Должен быть отправлен запрос на сервер
   - Должен быть получен ответ от сервера
5. Проверьте логи сервера на Render.com
6. Проверьте чат с ботом - файл должен быть там

